# Differentiable Robotic Simulation \{#chap:lagrangian_nn\}

------------------------------------------------------------------------

\
**Prerequisites:**
[\[chap:lagrangian_mechanics\]](#chap:lagrangian_mechanics)\{reference-type="ref+label"
reference="chap:lagrangian_mechanics"\},
[\[chap:hamiltonian_nn\]](#chap:hamiltonian_nn)\{reference-type="ref+label"
reference="chap:hamiltonian_nn"\}\
**Difficulty Level:** \*\*\

------------------------------------------------------------------------

Robotics simulation poses an interesting challenge problem for
mechanical modeling since it requires high fidelity modeling of friction
and contact dynamics. Simulations must also retain fidelity for long
time-scales, posing a challenge given the non-differentiable modeling
constraints. In this chapter, we study techniques for stabilizing
robotic simulations including maximal coordinate representations,
smoothing mechanics for contact dynamics, and a cone model for friction
dynamics. Implicit differentiable layers provide a unified framework for
addressing these questions.

Differentiable simulators of physics for robotics systems have become
increasingly important for robotic systems [@howell2022dojo].

## Differentiable Simulation

How can we make the simulation operation differentiable for an
instantaneous velocity change?

$$\begin\{aligned\}
    v^+ &= v^- + \Delta v
\end\{aligned\}$$

If $\Delta v$ is differentiable, then the update becomes differentiable.
More generally, a differentiable contact model can be broken into a
series of phases: the maximum dissipation principle, the compression
phase, and the restitution phase impulse.

All of these phases can be formulated as convex optimization problems.
We can use a differentiable convex layer to implement this.

$$\begin\{aligned\}
\underset\{f_C\}\{\textrm\{minimize \}\} \frac\{1\}\{2\}f_C^T A  f_C + f_C v^-
\end\{aligned\}$$

Constrained Lagrangian and Hamiltonian networks can be extended with a
differentiable contact model to model a broader class of networks.

$$\begin\{aligned\}
(\dot\{x\}, \dot\{v\}) &= g(x, v; M(x))
\end\{aligned\}$$ The contact model is given by $$\begin\{aligned\}
    \Delta v &= \textrm\{ContactModel\}(x, v; M_\{\theta\}(x), \mu, e_P) \\
    v&= v' + \Delta v
\end\{aligned\}$$

The framework can learn inertia, potential energy, and contact
properties.

## Maximal Coordinates Representation

Robotic systems often have closed kinematic loops, which introduce
numerical ill-conditioning to simulations.

Minimal coordinate representations use the base $(x,y,z)$ for a base and
angular offshifts $(\theta_1, \theta_2)$ for robotic hands. This makes a
quadruped robot have 37 dimensions. In a maximal representation, every
part of the robot has its own direct representation $(x_i, y_i, z_i)$.
This makes the representation dimension much higher.

## Variational Integrator

A variational integrator can be useful for applications where there is
good conservation of linear momentum, angular momentum, energy.

$$\begin\{aligned\}
    \mathcal\{S\} &= \int_\{t_1\}^\{t_2\} \mathcal\{L\} dt
\end\{aligned\}$$ The Euler-Lagrange equations can be applied to transform
this in to $F=ma$. The discretization is often applied at the end. A
variational integrator instead discretizes the action $$\begin\{aligned\}
    \mathcal\{S\}_D &= h \sum_\{i=1\}^N \mathcal\{L\}_i
\end\{aligned\}$$

This scheme helps better enforce energy conservation so we can take
longer timesteps.

## Higher Fidelity Contact Model

Most contact models have approximations which create unphysical
behaviors. For example, approximate friction can cause drift during
sliding. Another approximation for impact is soft contact, which can
cause impacting objects to sink upon impact and have floor penetration
which is aphysical.

It's common to have a \"friction cone\" in which friction is minimized
Kinetic energy is then minimized within this cone. A common
approximation is to use a friction \"pyramid\" of regions. This
approximation is aphysical though and can lead to error terms.

Conic optimization instead can be used to directly handle the nonlinear
friction model.

### Impact Model

There is a distance constraint $\phi \geq 0$ and the impact force
$\gamma \geq 0$. There is a constraint

$$\begin\{aligned\}
    \gamma \circ \phi(x) &= 0
\end\{aligned\}$$

This combination of constraints allows for better simulation of hard
contacts. The optimization problem to be solved is given by

$$\begin\{aligned\}
   & \underset\{x\}\{\textrm\{minimize\}\} f(x) \\
   & \textrm\{subject to \} \phi(x) \geq 0
\end\{aligned\}$$ This can be converted to a soft constraint
$$\begin\{aligned\}
    \textrm\{minimize\} f(x) - \kappa \log(\phi(x))
\end\{aligned\}$$

The smooth version of the objective allows for better optimization As
$\kappa \to 0$, the approximation gets steadily better. The KKT
conditions are

$$\begin\{aligned\}
   & \textrm\{find \} x, y \\
   & \textrm\{subject to \}  \nabla f(x) + \nabla \phi(x)^T \gamma = 0 \\
   & \gamma \cdot \phi(x) = 0 \\
   & \phi(x), \gamma \geq 0
\end\{aligned\}$$

As $\kappa \to 0$, the approximation to hard contact improves. $\kappa$
is iteratively improved through the simulation

## Gradient Handling Through Simulator

Picture a block being lifted off the ground. At start, the block won't
lift until the force exceeds gravity, which creates a nonsmooth
(ReLu-like) behavior. There is then a discontinuity in the gradient. The
smooth approximation used in this method allows for smooth gradients.

The actual interior point solver is differentiated through by the
implicit function theorem. $$\begin\{aligned\}
\frac\{\partial w^*\}\{\partial \theta\} &= - \left (\frac\{\partial r\}\{\partial w\}\right )^\{-1\} \frac\{\partial r\}\{\partial \theta\}
\end\{aligned\}$$ Here $w^*$ is the solution, $\theta$ is the data.
