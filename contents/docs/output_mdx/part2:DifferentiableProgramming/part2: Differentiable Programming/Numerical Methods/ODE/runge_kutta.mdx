# Runge-Kutta Method \{#chap:runge_kutta\}

------------------------------------------------------------------------

\
**Prerequisites:**
[\[chap:calculus\]](#chap:calculus)\{reference-type="ref+label"
reference="chap:calculus"\},
[\[chap:ode\]](#chap:ode)\{reference-type="ref+label"
reference="chap:ode"\}\
**Difficulty Level:** \*\*\

------------------------------------------------------------------------

In this chapter we will learn how to understand truncation errors for
Runge-Kutta methods. We will then study the representation of second and
fourth order Runge-Kutta methods. We will end by solving the
Cahn-Hilliard model using Runge-Kutta's fourth-order method.

## Runge-Kutta Methods

In previous chapters, we have discussed Euler's method which is accurate
to the first two terms of a Taylor series expansion. By evaluating the
slope at multiple places (instead of just the initial value), a better
estimate can be obtained. Runge-Kutta methods use this methodology and
achieves the accuracy of a Taylor series approach without requiring the
calculation of higher derivatives. Many variations exist but all can be
cast in the generalized form of $$\begin\{aligned\}
y_\{i+1\} = y_\{i\} + \phi h,
\end\{aligned\}$$ where $\phi$ is called an increment function, which can
be interpreted as a representative slope over the interval. The
increment function can be written in general form as

$$\begin\{aligned\}
\phi = a_\{1\}k_\{1\} + a_2k_2 + \dots + a_nk_n
\end\{aligned\}$$ where the $a$'s are constants and the $k$'s are
$$\begin\{aligned\}
    \begin\{split\}
        k_1 &= f(t_i,y_i) \\
        k_2 &= f(t_i + p_1h,y_i + q_\{11\}k_1h)\\
        k_3 &= f(t_i + p_2h,y_i + q_\{21\}k_1h+ q_\{22\}k_2h)\\ 
        \vdots&\\
        k_n &= f(t_i + p_\{n-1\}h,y_i + q_\{n-1,1\}k_1h + \dots + q_\{n-1,n-1\}k_\{n-1\}h)
        \vspace\{15pt\}
    \end\{split\}
\end\{aligned\}$$ where the $p$'s, $q$'s are constants and $f$ is the
derivative function $dy/dt$. Notice that the $k$'s are recurrence
relationships. That is, $k_1$ appears in the equation for $k_2$, which
appears in the equation for $k_3$, and so forth.

Various types of Runge-Kutta methods can be devised by employing
different numbers of terms in the increment function as specified by
$n$. It can be noted that the first-order RK method with $n$ = 1 is, in
fact, Euler's method. Once $n$ is chosen, values for the $a$'s, $p$'s,
and $q$'s are evaluated by setting the above equation equal to terms in
a Taylor series expansion. The second-order RK methods (uses an
increment function with two terms) and the fourth-order RK methods (uses
an increment function with four terms) will be discussed herewith. For
second-order methods, because terms with $h^3$ and higher are dropped
during the derivation, the local truncation error is O($h^3$) and the
global error is O($h^2$), Similarly, for fourth-order methods, the
global truncation error is O($h^4$).

## Second-Order Runge-Kutta Methods

The classical second-order Runge-Kutta method is simply obtained from
the Taylor series expansion of $y$. It is simplified as

$$\begin\{aligned\}
y_\{i+1\} &= y_i + f(t_i,y_i)h + \frac\{1\}\{2!\}f'(t_i,y_i)h^2 + O(h^3)  \\
y_\{i+1\} &= y_i + f(t_i,y_i)\frac\{h\}\{2\} + \left (\frac\{1\}\{2\}f(t_i,y_i) + \frac\{1\}\{2\}f'(t_i,y_i)h \right )h + O(h^3)\\
y_\{i+1\} &= y_i + \left (\frac\{1\}\{2\}f(t_i,y_i) + \frac\{1\}\{2\}f(t_i+h,y_i + f(t_i,y_i)h)\right )h + O(h^3)
\end\{aligned\}$$

::: marginfigure
Using Taylor series expansion, $$\begin\{aligned\}
    \begin\{split\}
f(t_i+h,y_i + f(t_i,y_i)h))& = f(t_i,y_i) + \frac\{\partial f\}\{\partial t\}h \\
& + \frac\{\partial f\}\{\partial y\}f(t_i,y_i)h+ O(h^2) \\
& = f(t_i,y_i) + \frac\{\partial f\}\{\partial y\}\frac\{\partial y\}\{\partial t\}h \\
& = f(t_i,y_i) + f'(t_i,y_i)h 
\end\{split\}
\end\{aligned\}$$
:::

This variant of the second-order Runge-kutta method is known as the
*Heun Method*. It can be re-written as

$$\begin\{aligned\}
y_\{i+1\} = y_\{i\} + \left (\frac\{1\}\{2\}k_1 + \frac\{1\}\{2\}k_2\right )h
\end\{aligned\}$$ where $$\begin\{aligned\}
k_1 = f(t_i,y_i);\hspace\{15pt\}  k_2 = f(t_i + h,y_i + k_1h) 
\end\{aligned\}$$ However, other variants of these second order RK-methods
exist. The general second-order version of the RK equation
$y_\{i+1\} = y_\{i\} + \phi h$ is given as $$\begin\{aligned\}
y_\{i+1\} = y_\{i\} + (a_1k_1 + a_2k_2)h
\end\{aligned\}$$ where

$$\begin\{aligned\}
k_1 = f(t_i,y_i) ; \hspace\{15pt\} k_2 = f(t_i + p_1h,y_i + q_\{11\}k_1h)       
\end\{aligned\}$$

The values of $a$'s, $p$ and $q$ are obtained by setting the above
equation equal to a second-order Taylor series. The first three terms of
the Taylor series expansion of y is written as $$\begin\{aligned\}
y_\{i+1\} = y_i + f(t_i,y_i)h + \frac\{1\}\{2!\}f'(t_i,y_i)h^2 + O(h^3)   
\end\{aligned\}$$

It can be noted that $dy/dt = f(t,y)$. Also, $$\begin\{aligned\}
f'(t_i,y_i) =\frac\{\partial f\}\{\partial t\} + \frac\{\partial f\}\{\partial y\}\frac\{\partial y\}\{\partial t\}
\end\{aligned\}$$

Substituting this back into the Taylor series expansion, we get
$$\begin\{aligned\}
y_\{i+1\} = y_i + f(t_i,y_i)h + \frac\{1\}\{2\}\left (\frac\{\partial f\}\{\partial t\} + \frac\{\partial f\}\{\partial y\}\frac\{\partial y\}\{\partial t\}\right )_\{|_\{(t_i,y_i)\}\}h^2 + O(h^3)
\end\{aligned\}$$

In a similar fashion, $k_2$ can be expanded as $$\begin\{aligned\}
k_2 = f(t_i + p_1h,y_i + q_\{11\}k_1h) = f(t_i,y_i) + p_1h\frac\{\partial f\}\{\partial t\} +  q_\{11\}k_1h\frac\{\partial f\}\{\partial y\} + O(h^2)   
\end\{aligned\}$$

Now, $y_\{i+1\} = y_\{i\} + (a_1k_1 + a_2k_2)h$ is simplified as
$$\begin\{aligned\}
\begin\{split\}
y_\{i+1\} & = y_i + \{a_1f(t_i,y_i) +  a_2(f(t_i,y_i) + p_1h\frac\{\partial f\}\{\partial t\} +  q_\{11\}k_1h\frac\{\partial f\}\{\partial y\} + O(h^2))\}h \\
 & = y_i + (a_1+a_2)hf(t_i,y_i) + a_2p_1h^2\frac\{\partial f\}\{\partial t\} + a_2q_\{11\}f(t_i,y_i)h^2\frac\{\partial f\}\{\partial y\}+ O(h^3)
\end\{split\}
\end\{aligned\}$$

On comparing the above equation with (1), three equations can be derived
to evaluate the four unknown constants. $$\begin\{aligned\}
a_1 + a_2 = 1 ; \hspace\{10pt\}a_2p_1 = 1/2; \hspace\{10pt\} a_2q_\{11\} = 1/2
\end\{aligned\}$$

These equations are *underdetermined*, since we have 3 equations with 4
unknowns. Therefore, a value is assumed for one of the unknowns to
determine the other three. Suppose that we specify a value for $a_2$,
then the equations can be solved as

$$\begin\{aligned\}
        a_1 = 1 - a2; \hspace\{10pt\} p_1 = q_\{11\} = \dfrac\{1\}\{2a_2\}
\end\{aligned\}$$

Because we can choose an infinite number of values for $a_2$, there are
an infinite number of second-order RK methods. Every version would yield
exactly the same results if the solution to the ODE were quadratic,
linear, or a constant. However, they yield different results when (as is
typically the case) the solution is more complicated. Two of the most
commonly used and preferred versions apart from the Heun's method are
discussed here.

### The Midpoint Method ($a_2 = 1$)

In this method, $a_2$ is assumed to be 1 and can be solved for $a_1$ = 0
and $p_1$ = $q_\{11\}$ = 1/2 to obtain $$\begin\{aligned\}
y_\{i+1\} = y_\{i\} + k_2h
\end\{aligned\}$$ where $$\begin\{aligned\}
k_1 = f(t_i,y_i); \hspace\{15pt\}k_2 = f(t_i + \frac\{1\}\{2\}h,y_i + \frac\{1\}\{2\}k_1h)    
\end\{aligned\}$$

### Ralston's Method ($a_2 = 2/3$)

Ralston and Rabinowitz (1978) determined that choosing $a_2$ = 2/3
provides a minimum bound on the truncation error for the second-order RK
algorithms. In this method, $a_2$ is assumed to be 2/3 and can be solved
for $a_1$ = 1/3 and $p_1$ = $q_\{11\}$ = 3/4 to obtain $$\begin\{aligned\}
y_\{i+1\} = y_\{i\} + (\frac\{1\}\{3\}k_1 + \frac\{2\}\{3\}k_2)h
\end\{aligned\}$$ where $$\begin\{aligned\}
k_1 = f(t_i,y_i);\hspace\{15pt\}  k_2 = f(t_i + \frac\{3\}\{4\}h,y_i + \frac\{3\}\{4\}k_1h)   
\end\{aligned\}$$

## 3-8th Rule Fourth-Order Runge-Kutta Method

The most popular RK methods are fourth order. As with the second-order
approaches, there are an infinite number of versions. These can be
solved for by using a similar approach discussed in the second-order
methods. The following variant is one of the most commonly used form.
The 3/8th rule fourth-order RK method is similar to Simpson's 3/8 rule
in case of ODEs that are a function of *t* alone. It is given as

$$\begin\{aligned\}
y_\{i+1\} = y_\{i\} + \frac\{1\}\{8\}(k_1 + 3k_2 + 3k_3 + k_4)h
\end\{aligned\}$$ where $$\begin\{aligned\}
\begin\{split\}
k_1 &= f(t_i,y_i) \\
k_2 &= f(t_i + \frac\{1\}\{3\}h,y_i + \frac\{1\}\{3\}k_1h)\\
k_3 &= f(t_i + \frac\{2\}\{3\}h,y_i - \frac\{1\}\{3\}k_1h + k_2h)\\ 
k_4 &= f(t_i + h,y_i + k_1h - k_2h + k_3h)
\end\{split\}
\end\{aligned\}$$

::: marginfigure
Classical Fourth order Runge-Kutta method:
$$y_\{i+1\} = y_\{i\} + \frac\{1\}\{6\}(k_1 + 2k_2 + 2k_3 + k_4)h
    \vspace\{-6pt\}$$ where $$\begin\{aligned\}
        \begin\{split\}
            k_1 &= f(t_i,y_i) \\
            k_2 &= f(t_i + \frac\{1\}\{2\}h,y_i + \frac\{1\}\{2\}k_1h)\\
            k_3 &= f(t_i + \frac\{1\}\{2\}h,y_i + \frac\{1\}\{2\}k_2h)\\    
            k_4 &= f(t_i + h,y_i + k_3h)
        \end\{split\}
    
\end\{aligned\}$$
:::

It can also be noted that a variant of third-order Runge-Kutta method is
also similar to the Simpson's 1/3 rule. In addition, the fourth-order RK
method is similar to the Heun approach in that previous estimates of the
slope are considered to come up with an improved average slope for the
interval. It can also be observed that each of these $k$'s represent a
slope and a weighted average of these is considered to arrive at the
final improved slope. Another most commonly used variant, is the
*classical fourth-order method*.

## Solving Cahn-Hilliard with the Runge-Kutta Method

Let's consider the Cahn-Hilliard Equation which is an example of a
non-linear differential equation describing the process of phase
separation, by which the two components of a binary fluid spontaneously
separate and form domains which are pure in each component. The
Cahn-Hilliard Equation is given as $$\begin\{aligned\}
\dfrac\{\partial c\}\{\partial t\} = D \nabla^2 (c^3 - c - \gamma \nabla^2c )
\end\{aligned\}$$ Let's solve the Cahn-Hilliard equation given above using
the 3/8th rule fourth order Runge-Kutta's method from $t=0$ to $t=5$
with initial conditions as randomized values of -1 and 1 scattered over
a grid. We use a time step $(h)$ of $0.002$ s, a diffusion coefficient
of $20$ and gamma of $0.5$.

``` \{.python language="python"\}
def $\frac\{\partial c\}\{\partial t\}$(c, dx, dy, D, gamma):
  return D*$\nabla^2$(c$^3$-c-$\gamma$*$\nabla^2$c, dx, dy)
```

Note that above, by specifying `dx,dy`, we are constraining the
Laplacian $\nabla^2$ to use a numeric approximation rather than the
analytical calculation. In particular, we use a central difference to
approximate the second-order derivative at a grid element. We start by
initializing a grid.

``` \{.python language="python"\}
def initialize_grid(N: $\mathbb\{N\}$) $\to \mathbb\{R\}^\{N \times N\}$:
  C = zeros(N, N)
  for i j:
    temp = randi(2)
    if (temp==1):
      C[j,i] = -1
    else 
      C[j,i] = 1
C: $\mathbb\{R\}^\{N, N\}$ = initialize_grid(N)
```

And then we can define a general Runge-Kutta operation

``` \{.python language="python"\}
def runge_kutta($\gamma$ : $\mathbb\{R\}$, D: $\mathbb\{R\}$, dt: $\mathbb\{R\}$, $t_0$: $\mathbb\{R\}$, $t_e$: $\mathbb\{R\}$):
  t = $t_0$
  while t < $t_e$:
    k1 = $\frac\{\partial c\}\{\partial t\}$(C, dx, dy, D, $\gamma$)  
    $C_2$ =  C + dt/3*k1
    k2 = $\frac\{\partial c\}\{\partial t\}$($C_2$, dx, dy, D, $\gamma$)
    $C_3$ =  C + 2*dt/3*k2
    k3 = $\frac\{\partial c\}\{\partial t\}$($C_3$, dx, dy, D, $\gamma$)
    $C_4$ =  C + dt*k3
    k4 = $\frac\{\partial c\}\{\partial t\}$($C_4$, dx, dy, D, $\gamma$)
    C = C + dt*(k1 + 3*k2 + 3*k3 + k4)/8
    C = bound_conc(C)
    t = t + dt
```

The function $\frac\{\partial c\}\{\partial t\}$ estimates the derivative at
the specified concentration. The function `bound\_conc`() ensures that
the concentration lies within \[-1,1\]. A slightly generalized version
of the equation above can be constructed that applies Runge-Kutta to any
differential equation system rather than the Cahn-Hilliard equation.
