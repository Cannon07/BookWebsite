# Molecular Representations and Featurizations \{#chap:molecular_ml\}

------------------------------------------------------------------------

\
**Prerequisites:**
[\[chap:graphconvs\]](#chap:graphconvs)\{reference-type="ref+label"
reference="chap:graphconvs"\},
[\[chap:molecular_hamiltonian\]](#chap:molecular_hamiltonian)\{reference-type="ref+label"
reference="chap:molecular_hamiltonian"\}\
**Difficulty Level:** \*\*\

------------------------------------------------------------------------

Molecules, groups of two or more atoms held together by chemical bonds,
form the smallest repeating units of materials. Identifying the optimal
molecule for an application, such as designing a medical drug or a
battery electrolyte, depends on emergent properties that emerge from
interactions at the molecular length scale. Models that predict emergent
collective properties are consequently of enormous value in practical
applications. In this chapter, we will learn about the basics of
molecular machine learning and molecular featurization. Molecular
featurizations use heuristic methods to compute useful properties of a
molecular structure for use in downstream learning pipelines.

## Molecular Featurization

In order to use machine learning to predict molecular properties, we
need to encode properties of the molecule, or \"features\" that a
learning algorithm can discern patterns from. Several molecular
featurization techniques have been proposed in order to calculate
molecular descriptors such as functional groups, residual charges,
dipole moments, inter-atom distance metrics and bonding features.
Especially in more complex systems, generating refined molecular
features becomes important to capture the subtle interplay of
interactions such as hydrogen bonding and van del Waals forces in
predicting collective behavior and emergent properties. Generated
features are typically used as input to train appropriate machine
learning models to predict collective properties that are relevant in
the material selection process.

### Smiles Representation of Molecules

Molecular machine learning relies on effective encoding of molecules
into fixed-length strings or vectors. The simplified molecular-input
line-entry system (SMILES) refers to a line notation (a typographical
method using printable characters) for encoding the composition, bonding
and structure of molecules.

Examples of molecules and their associated SMILES stirngs are given in
TableÂ [1.1](#table:smiles)\{reference-type="ref"
reference="table:smiles"\}. SMILES strings can be used to uniquely
represent molecules, and enable an effective starting point for
molecular featurization methods. Such methods process the SMILES to
generate fixed-length feature vectors and/or matrices. Note that the
SMILES representation includes only heavy (non hydrogen) atoms with the
assumption that unsatisfied bonds are occupied by hydrogen atoms

::: \{#table:smiles\}
       Molecule       Molecular Formula    SMILES string/ID
  ------------------ -------------------- ------------------
        Oxygen              O$_2$                O=O
       Propane        CH$_3$CH$_2$CH$_3$         CCC
       Ethanol          CH$_3$CH$_2$OH           CCO
     Acetic acid          CH$_3$COOH           CC(=O)O
     Cyclohexane        C$_6$H$_\{12\}$          C1CCCCC1
   Hydrogen Cyanide          HCN                 C#N
:::

[]\{#table:smiles label="table:smiles"\}

SMILES strings offer a way to uniquely represent molecules as strings,
but most molecular machine learning methods require additional
information such as bonding characteristics, composition and
connectivity to learn sophisticated features of molecules from limited
amounts of data. Prior work has demonstrated that SMILES strings can be
used to predict emergent properties based on the ability to effectively
encode molecules from SMILES representations using more sophisticated
representations.

### Extended Connectivity Fingerprints (ECFP)

Extended-Connectivity fingerprints are extensively used for molecular
characterizations in chemical informatics[@rogers2010extended]. These
fingerprints transform a SMILES representation of a molecule into a
sparse bitvector that can be used in a downstream machine learning
pipeline. To generate the ECFP vector, a molecule is first decomposed
into submodules originated from heavy atoms (non-hydrogen), each
assigned with a unique identifier. The submodules (segments) and
identifiers are extended through bonds to generate larger substructures
and associated identifiers. These substructures are hashed into a fixed
length binary fingerprint. This approach to encoding molecules enables
it to be applied to tasks such as similarity searching and prediction of
collective properties since it contains information about topological
characteristics of the molecule.

To implement the circular fingerprint algorithm, we will assume we have
access to some hash function with the following type signature

``` \{.python language="python"\}
hash: $\forall$ n, $\mathbb\{Z\}_2^N$ -> $\mathbb\{Z\}_2^k$
```

We then define the fingerprint computation itself below, where `R` is
the neighbor radius considered, `S` is the size of the fingerprint, and
`g` is a mapping of each atom to a bit vector of features.

``` \{.python language="python"\}
class CircularFingerprint(R: $\mathbb\{N\}$, S: $\mathbb\{N\}$, g: Node -> $\mathbb\{Z\}_2^k$):

  def $\lambda$(molecule: Graph):
    f = zeros(S)
    # Loop over atoms
    for a in molecule: 
      r[a] = g(a)
    for L in [1,$\dotsc$, R]:
      nbrs = neighbors(a)
      vec = r[a] || nbrs
      r[a] = hash(vec)
      i = mod(r[a], S)
      f[i] = 1
    return f
```

## The Design Workflow

A typical design process for identifying molecular candidates for any
given application involves the following steps:

-   Identifying quantitative design criteria and associated molecular
    properties of relevance, and using these to generate features
    summarizing the molecule.

-   Training an appropriate machine learning model (performing
    hyperparameter and architecture optimization, etc.), and then
    validating and testing the model's ability to predict the identified
    molecular properties of interest.

-   Identifying candidates that meet the quantitative design criteria
    using predictions from machine learning models

-   Performing experimental testing to measure the true properties of
    promising candidates, and creating a feedback loop with new training
    data to refine the featurization and prediction models

This design loop is often called the active learning process whereby
machine learning models are used to guide experimental design. We
discuss it here in the context of molecules, but more generally a
similar process applies for materials discovery or engineering design as
well.

![Typical workflow for making machine learning based property
predictions for molecular structures. A molecular structure is
transformed into a numerical representation called features or
descriptors. The features are then used as an input for a machine
learning model that is trained to output a property for the structure.
There is also a possibility of combining the descriptor and learning
model together into one inseparable step.
](figures/Differentiable Physics/Molecular ML/Molecular Featurizations/ML_typical_Workflow.png)\{#fig:typicalWorkflow
width="\\linewidth"\}

In subsequent chapters, we will expand on different choices for each of
these modeling steps.

## Exercises

1.  Generate the SMILES string for acetaminophen
    (HOC$_6$H$_4$NHCOCH$_3$)

2.  Compute the ECFP fingerprint for this molecule.
