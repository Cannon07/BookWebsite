# Learning Force Fields \{#chap:forcebalance\}

------------------------------------------------------------------------

\
**Prerequisites:**
[\[chap:molecular_hamiltonian\]](#chap:molecular_hamiltonian)\{reference-type="ref+label"
reference="chap:molecular_hamiltonian"\},\
**Difficulty Level:** \*\*\

------------------------------------------------------------------------

One of the largest challenges in learning force fields is that very long
timescale molecular dynamics simulations must be run in order to compute
physical quantities. Updating parameters through very long simulation
runs proves a profound challenge.

The ForceBalance methodology provides a method for automatic force field
learning by approximating a numerical derivative from the results of
simulation runs. This approach side-steps the numerical instability from
automatically differentiating backwards through very long simulations.

## Computing Thermodynamic Properties

A thermodynamic average property may be computed by evaluating the
integral $$\begin\{aligned\}
\langle A \rangle_\theta &= \frac\{1\}\{Z(r, V, \theta)\} A(r, V, \theta) \exp(-\beta E(r, V,\theta) + PV)dr
\end\{aligned\}$$ where $\theta$ is the set of parameters of the force
field, $Z$ is the isothermal-isobaric partition function, $r$ is the
molecular configuration, $T$ the temperature, $P$ the pressure and $V$
the volume. We can compute the gradient of this quantity with respect to
$\theta$

$$\begin\{aligned\}
\frac\{d\}\{d\theta\} \langle A \rangle_\theta &= \left \langle \frac\{\partial A\}\{\partial \theta\} \right \rangle - \beta \left ( \left \langle A \frac\{\partial E\}\{\partial \theta\} \right \rangle_\theta - \langle A \rangle_\theta \left \langle \frac\{\partial E\}\{\partial \theta\} \right \rangle_\theta \right )
\end\{aligned\}$$ These quantities can be directly computed from the
forward simulations. The force field parameters $\theta$ can then be
optimized with respect to a set of reference properties
$A_1,\dotsc,A_n$.

Empirically, it proves useful to place a regularizer to help control for
overfitting.
